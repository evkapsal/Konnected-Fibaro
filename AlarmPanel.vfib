{"name":"Alarm Panel","type":"virtual_device","properties":{"deviceIcon":1001,"currentIcon":"1001","log":"","logTemp":"","mainLoop":"-- Initiate Variables\nfibaro:debug(\"starting debug\");\nlocal thisId= fibaro:getSelfId();\nfibaro:debug(\"id:\"..thisId);\nlocal ipaddr= fibaro:getValue(thisId,\"IPAddress\");\nfibaro:debug(\"IP:\"..ipaddr);\nlocal port= fibaro:getValue(thisId, \"TCPPort\");\nfibaro:debug(\"Port:\"..port);\nfibaro:log('Konnected: Running');\nfibaro:debug(os.date(\"%c\"))\nfibaro:call(thisId, \"setProperty\", \"ui.dtime.value\", os.date(\"%c\"));\n\n--ZoneResponse Function\nfunction zoneresponse(ipaddr,port)\n  konnected= Net.FHttp(ipaddr, port)\n  reqstr= \"/device\"\n  response= konnected:GET(tostring(reqstr))\n  fibaro:debug(\"Response:\" .. tostring(response))\n  if (pcall(function() return json.decode(response) end)) then\n\tzonestate= json.decode(response)\n\treturn zonestate\n  else\n\tfibaro:debug(\"No Response from Konnected\" .. tostring(response))\n    fibaro:log('Konnected: Error');\n\tfibaro:sleep(3000)\n  end\nend\n\t\n-- Get Zone States and Update Labels\t\nzonestate = zoneresponse(ipaddr,port)\nfor i in pairs(zonestate) do\n--fibaro:debug(\"Zone state:\" .. tostring(zonestate[i].state) .. \",Pin:\" .. tostring(zonestate[i].pin))\n\tif (zonestate[i].pin == 1) then\n\t\tlocal zone1state = zonestate[i].state\n\t\tif zone1state == 0 then\n\t\t\tfibaro:call(thisId, \"setProperty\", \"ui.doorId.value\",\"Closed\")\n\t\t\tfibaro:debug(\"Zone 1 Door is Closed\")\n\t\telseif zone1state == 1 then\n\t\t\tfibaro:call(thisId, \"setProperty\", \"ui.doorId.value\",\"Opened\")\n\t\t\tfibaro:debug(\"Zone 1 Door is Opened\")\n\t\tend\n\telseif (zonestate[i].pin == 2) then\n\t\tlocal zone2state = zonestate[i].state\n\t\tif zone2state == 0 then\n\t\t\tfibaro:call(thisId, \"setProperty\", \"ui.motionId.value\",\"Idle\")\n\t\t\tfibaro:debug(\"Zone 2 no motion detected\")\n\t\telseif zone2state == 1 then\n\t\t\tfibaro:call(thisId, \"setProperty\", \"ui.motionId.value\",\"Detected\")\n\t\t\tfibaro:debug(\"Zone 2 motion detected\")\n\t\tend\n\telseif (zonestate[i].pin == 5) then\n\t\tlocal zone3state = zonestate[i].state\n\t\tif zone3state == 0 then\n\t\t\tfibaro:call(thisId, \"setProperty\", \"ui.balconyId.value\",\"Closed\")\n\t\t\tfibaro:debug(\"Zone 3 Balcony Door is Closed\")\n\t\telseif zone3state == 1 then\n\t\t\tfibaro:call(thisId, \"setProperty\", \"ui.balconyId.value\",\"Opened\")\n\t\t\tfibaro:debug(\"Zone 3 Balcony Door is Opened\")\n\t\tend\n\telseif (zonestate[i].pin == 6) then\n\t\tlocal zone4state = zonestate[i].state\n\t\tif zone4state == 0 then\n\t\t\tfibaro:call(thisId, \"setProperty\", \"ui.kitchedId.value\",\"Closed\")\n\t\t\tfibaro:debug(\"Zone 4 Kitchen Door is Closed\")\n\t\telseif zone4state == 1 then\n\t\t\tfibaro:call(thisId, \"setProperty\", \"ui.kitchedId.value\",\"Opened\")\n\t\t\tfibaro:debug(\"Zone 4 Kitchen Door is Opened\")\n\t\tend\n\n\telseif (zonestate[i].pin == 7) then\n\t\tlocal zone5state = zonestate[i].state\n\t\tif zone5state == 0 then\n\t\t\tfibaro:call(thisId, \"setProperty\", \"ui.bedId.value\",\"Closed\")\n\t\t\tfibaro:debug(\"Zone 5 Bedroom Door is Closed\")\n\t\telseif zone5state == 1 then\n\t\t\tfibaro:call(thisId, \"setProperty\", \"ui.bedId.value\",\"Opened\")\n\t\t\tfibaro:debug(\"Zone 5 Bedroom Door is Opened\")\n\t\tend\n\telseif (zonestate[i].pin == 9) then\n\t\tlocal zone6state = zonestate[i].state\n\t\tif zone6state == 0 then\n\t\t\tfibaro:call(thisId, \"setProperty\", \"ui.winId.value\",\"Closed\")\n\t\t\tfibaro:debug(\"Zone 6 WC Window is Closed\")\n\t\telseif zone6state == 1 then\n\t\t\tfibaro:call(thisId, \"setProperty\", \"ui.winId.value\",\"Opened\")\n\t\t\tfibaro:debug(\"Zone 6 WC Window is Opened\")\n\t\tend\n\tend\nend\t\nfibaro:sleep(2000)","ui.balconyId.value":"Closed","ui.bedId.value":"Closed","ui.doorId.value":"Closed","ui.dtime.value":"Sat Feb 16 01:46:42 2019","ui.kitchedId.value":"Closed","ui.motionId.value":"Idle","ui.winId.value":"Closed","visible":"true","rows":[{"type":"label","elements":[{"id":1,"lua":false,"waitForResponse":false,"caption":"Door","name":"doorId","favourite":false,"main":false}]},{"type":"label","elements":[{"id":2,"lua":false,"waitForResponse":false,"caption":"Motion","name":"motionId","favourite":false,"main":false}]},{"type":"label","elements":[{"id":3,"lua":false,"waitForResponse":false,"caption":"Balcony","name":"balconyId","favourite":false,"main":false}]},{"type":"label","elements":[{"id":4,"lua":false,"waitForResponse":false,"caption":"Kitchen","name":"kitchedId","favourite":false,"main":false}]},{"type":"label","elements":[{"id":5,"lua":false,"waitForResponse":false,"caption":"Bedrooms","name":"bedId","favourite":false,"main":false}]},{"type":"label","elements":[{"id":6,"lua":false,"waitForResponse":false,"caption":"WC Window","name":"winId","favourite":false,"main":false}]},{"type":"label","elements":[{"id":7,"lua":false,"waitForResponse":false,"caption":"Datetime","name":"dtime","favourite":false,"main":false}]}]},"actions":{"pressButton":1,"setSlider":2,"setProperty":2}}