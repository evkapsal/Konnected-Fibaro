{"name":"Alarm Panel","type":"virtual_device","properties":{"deviceIcon":1001,"currentIcon":"1001","log":"Konnected: Running","logTemp":"TxtGreen","mainLoop":"-- Initiate Variables\nfibaro:debug(\"starting debug\");\nlocal thisId= fibaro:getSelfId();\nfibaro:debug(\"id:\"..thisId);\nlocal ipaddr= fibaro:getValue(thisId,\"IPAddress\");\nfibaro:debug(\"IP:\"..ipaddr);\nlocal port= fibaro:getValue(thisId, \"TCPPort\");\nfibaro:debug(\"Port:\"..port);\nfibaro:log('Konnected: Running');\nfibaro:debug(os.date(\"%c\"))\nfibaro:call(thisId, \"setProperty\", \"ui.dtime.value\", os.date(\"%c\"));\n\n--ZoneResponse Function\nfunction zoneresponse(ipaddr,port)\n  konnected= Net.FHttp(ipaddr, port)\n  reqstr= \"/device\"\n  response= konnected:GET(tostring(reqstr))\n  fibaro:debug(\"Response:\" .. tostring(response))\n  if (pcall(function() return json.decode(response) end)) then\n\tzonestate= json.decode(response)\n\treturn zonestate\n  else\n\tfibaro:debug(\"No Response from Konnected\" .. tostring(response))\n    fibaro:log('Konnected: Error');\n\tfibaro:sleep(3000)\n  end\nend\n\t\n-- Get Zone States and Update Labels\t\nzonestate = zoneresponse(ipaddr,port)\nif (zonestate ~= null or zonestate ~= nil) then\n  fibaro:debug(\"Message:\" .. json.encode(zonestate))\n  for i in pairs(zonestate) do\n  --fibaro:debug(\"Zone state:\" .. tostring(zonestate[i].state) .. \",Pin:\" .. tostring(zonestate[i].pin))\n      if (zonestate[i].pin == 1) then\n          local zone1state = zonestate[i].state\n          if zone1state == 0 then\n              fibaro:call(thisId, \"setProperty\", \"ui.doorId.value\",\"Closed\")\n              fibaro:debug(\"Zone 1 Door is Closed\")\n          elseif zone1state == 1 then\n              fibaro:call(thisId, \"setProperty\", \"ui.doorId.value\",\"Opened\")\n              fibaro:debug(\"Zone 1 Door is Opened\")\n          end\n      elseif (zonestate[i].pin == 2) then\n          local zone2state = zonestate[i].state\n          if zone2state == 0 then\n              fibaro:call(thisId, \"setProperty\", \"ui.motionId.value\",\"Idle\")\n              fibaro:debug(\"Zone 2 no motion detected\")\n          elseif zone2state == 1 then\n              fibaro:call(thisId, \"setProperty\", \"ui.motionId.value\",\"Detected\")\n              fibaro:debug(\"Zone 2 motion detected\")\n          end\n      elseif (zonestate[i].pin == 5) then\n          local zone3state = zonestate[i].state\n          if zone3state == 0 then\n              fibaro:call(thisId, \"setProperty\", \"ui.balconyId.value\",\"Closed\")\n              fibaro:debug(\"Zone 3 Balcony Door is Closed\")\n          elseif zone3state == 1 then\n              fibaro:call(thisId, \"setProperty\", \"ui.balconyId.value\",\"Opened\")\n              fibaro:debug(\"Zone 3 Balcony Door is Opened\")\n          end\n      elseif (zonestate[i].pin == 6) then\n          local zone4state = zonestate[i].state\n          if zone4state == 0 then\n              fibaro:call(thisId, \"setProperty\", \"ui.kitchedId.value\",\"Closed\")\n              fibaro:debug(\"Zone 4 Kitchen Door is Closed\")\n          elseif zone4state == 1 then\n              fibaro:call(thisId, \"setProperty\", \"ui.kitchedId.value\",\"Opened\")\n              fibaro:debug(\"Zone 4 Kitchen Door is Opened\")\n          end\n  \n      elseif (zonestate[i].pin == 7) then\n          local zone5state = zonestate[i].state\n          if zone5state == 0 then\n              fibaro:call(thisId, \"setProperty\", \"ui.bedId.value\",\"Closed\")\n              fibaro:debug(\"Zone 5 Bedroom Door is Closed\")\n          elseif zone5state == 1 then\n              fibaro:call(thisId, \"setProperty\", \"ui.bedId.value\",\"Opened\")\n              fibaro:debug(\"Zone 5 Bedroom Door is Opened\")\n          end\n      elseif (zonestate[i].pin == 9) then\n          local zone6state = zonestate[i].state\n          if zone6state == 0 then\n              fibaro:call(thisId, \"setProperty\", \"ui.winId.value\",\"Closed\")\n              fibaro:debug(\"Zone 6 WC Window is Closed\")\n          elseif zone6state == 1 then\n              fibaro:call(thisId, \"setProperty\", \"ui.winId.value\",\"Opened\")\n              fibaro:debug(\"Zone 6 WC Window is Opened\")\n          end\n      end\n  end\n  else\n    fibaro:debug(\"No Valid Response from Konnected: \" .. tostring(zonestate))\n    fibaro:log('Konnected: Error');\n    fibaro:sleep(3000)\nend\nfibaro:sleep(2000)","ui.balconyId.value":"Closed","ui.bedId.value":"Closed","ui.doorId.value":"Closed","ui.dtime.value":"Sat Feb 16 03:04:58 2019","ui.kitchedId.value":"Closed","ui.motionId.value":"Idle","ui.winId.value":"Closed","visible":"true","rows":[{"type":"label","elements":[{"id":1,"lua":false,"waitForResponse":false,"caption":"Door","name":"doorId","favourite":false,"main":false}]},{"type":"label","elements":[{"id":2,"lua":false,"waitForResponse":false,"caption":"Motion","name":"motionId","favourite":false,"main":false}]},{"type":"label","elements":[{"id":3,"lua":false,"waitForResponse":false,"caption":"Balcony","name":"balconyId","favourite":false,"main":false}]},{"type":"label","elements":[{"id":4,"lua":false,"waitForResponse":false,"caption":"Kitchen","name":"kitchedId","favourite":false,"main":false}]},{"type":"label","elements":[{"id":5,"lua":false,"waitForResponse":false,"caption":"Bedrooms","name":"bedId","favourite":false,"main":false}]},{"type":"label","elements":[{"id":6,"lua":false,"waitForResponse":false,"caption":"WC Window","name":"winId","favourite":false,"main":false}]},{"type":"label","elements":[{"id":7,"lua":false,"waitForResponse":false,"caption":"Datetime","name":"dtime","favourite":false,"main":false}]}]},"actions":{"pressButton":1,"setSlider":2,"setProperty":2}}